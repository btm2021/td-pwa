<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Husky">
    <meta name="theme-color" content="#131722">
    <link rel="manifest" href="manifest.json">

    <title>Husky Trading</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/image/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/image/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/image/icons/icon-512x512.png">

    <link rel="stylesheet" href="styles.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            height: 100dvh;
            /* Use dynamic viewport height */
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            margin: 0;
            padding: 0;
            background-color: #131722;
            overscroll-behavior: none;
            -webkit-user-select: none;
            user-select: none;
        }

        #tv_chart_container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            touch-action: none;
        }

        /* Chỉ thêm padding cho safe area khi ở chế độ PWA standalone */
    </style>
</head>

<body>
    <div id="tv_chart_container"></div>


    <!-- Sidebar Menu Overlay -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <!-- Sidebar Menu -->
    <div id="sidebar-menu" class="sidebar-menu">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="logo-icon">H</div>
                <span class="notification-badge">1</span>
            </div>
            <div class="sidebar-title">Husky</div>
        </div>

        <div class="sidebar-content">
            <!-- User Info (Logged In) -->
            <div id="user-info-section" class="user-info" style="display: none;">
                <div class="user-avatar">U</div>
                <div class="user-name">User Name</div>
                <svg class="chevron-right" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </div>

            <!-- Sign In (Logged Out) -->
            <div id="login-section" class="menu-section">
                <div class="menu-item" id="login-btn">
                    <span class="menu-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                            <polyline points="10 17 15 12 10 7"></polyline>
                            <line x1="15" y1="12" x2="3" y2="12"></line>
                        </svg>
                    </span>
                    <span>Đăng nhập</span>
                </div>
            </div>

            <div class="menu-divider"></div>

            <div class="menu-section">
                <div class="menu-item" id="sidebar-search-btn">
                    <span class="menu-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </span>
                    <span>Tìm kiếm mã</span>
                </div>

                <div class="menu-item" id="sidebar-indicators-btn">
                    <span class="menu-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 3v18h18"></path>
                            <path d="M18 17l-6-6-4 4-5-5"></path>
                        </svg>
                    </span>
                    <span>Chỉ báo</span>
                </div>
            </div>

            <div class="menu-section">
                <div class="menu-item">
                    <span class="menu-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path
                                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                            </path>
                        </svg>
                    </span>
                    <span>Cài đặt</span>
                </div>

                <div class="menu-item">
                    <span class="menu-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    </span>
                    <span>Giao diện tối</span>
                    <label class="toggle-switch">
                        <input type="checkbox" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="menu-item" id="always-on-toggle">
                    <span class="menu-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                    </span>
                    <span>Giữ màn hình sáng</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="always-on-checkbox" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="menu-item">
                    <span class="menu-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="2" y1="12" x2="22" y2="12"></line>
                            <path
                                d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z">
                            </path>
                        </svg>
                    </span>
                    <span>Ngôn ngữ</span>
                    <span class="menu-value">Tiếng Việt</span>
                </div>
            </div>

            <div class="menu-divider"></div>

            <div id="logout-section" class="menu-section" style="display: none;">
                <div class="menu-item logout" id="logout-btn">
                    <span class="menu-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                    </span>
                    <span>Đăng xuất</span>
                </div>
            </div>
        </div>
    </div>
    <script src="menu.js"></script>
    <script src="notes-button.js"></script>
    <script src="custom_studies/atr-bot.js"></script>
    <script src="custom_studies/vsr.js"></script>
    <script src="custom_studies/vsr_1.js"></script>
    <script src="custom_studies/vidya.js"></script>
    <script src="custom_studies/session-vp.js"></script>
    <script src="custom_studies/swing-points.js"></script>
    <script src="custom_studies/kama.js"></script>
    <script src="custom_studies/smc.js"></script>
    <script src="custom_studies/fvg.js"></script>


    <script src="charting_library/charting_library.js"></script>
    <script src="save-load-adapter.js"></script>
    <script src="datafeeds/base-datasource.js"></script>
    <script src="datafeeds/oanda-datasource.js"></script>
    <script src="datafeeds/binance-futures-datasource.js"></script>
    <script src="datafeeds/binance-spot-datasource.js"></script>
    <script src="datafeeds/datafeed-manager.js"></script>
    <script src="embed-app.js"></script>

    <script>
        // 1. Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('SW registered'))
                    .catch(err => console.log('SW error', err));
            });
        }

        // 2. Prevent Page-Level Zoom (Lock to Chart)
        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) {
                // Prevent multi-touch zoom on page level
                // But allow if inside chart (TV library handles its own touch)
                if (!e.target.closest('#tv_chart_container')) {
                    e.preventDefault();
                }
            }
        }, { passive: false });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                // Prevent double-tap zoom on page level
                if (!e.target.closest('#tv_chart_container')) {
                    e.preventDefault();
                }
            }
            lastTouchEnd = now;
        }, false);

        // 3. Fix Rotation (Orientation Change) Zoom/Viewport Issues
        window.addEventListener('orientationchange', () => {
            // Force viewport to reset
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover');

                // Hack to force reflow on orientation change to fix layout glitches
                setTimeout(() => {
                    window.scrollTo(0, 0);
                    document.body.style.display = 'none';
                    document.body.offsetHeight; // force reflow
                    document.body.style.display = '';
                }, 200);
            }
        });

        // 4. Handle Visual Viewport changes (Keyboard etc)
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                // Keep the page locked at the top
                window.scrollTo(0, 0);
            });
        }

        // 5. Sidebar Symbol Search & Indicators
        document.getElementById('sidebar-search-btn')?.addEventListener('click', () => {
            window.userMenu?.close(); // Close menu first
            setTimeout(() => {
                window.embedWidget?.openSymbolSearch();
            }, 300);
        });

        document.getElementById('sidebar-indicators-btn')?.addEventListener('click', () => {
            window.userMenu?.close(); // Close menu first
            setTimeout(() => {
                window.embedWidget?.openIndicators();
            }, 300);
        });

    </script>
</body>

</html>